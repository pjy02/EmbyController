# 日志管理功能说明

## 功能概述

本系统提供了一个完整的网页日志管理界面，无需配置crontab等定时任务即可实现日志的自动管理。主要功能包括：

- 📋 日志文件列表查看
- 🗑️ 单个/批量删除日志文件
- ⚙️ 日志保存期限设置
- 🔄 自动清理过期日志
- 👁️ 日志文件内容预览
- 📊 日志统计信息

## 安装步骤

### 1. 数据库迁移

首先需要创建配置表来存储日志管理相关的配置信息：

```bash
# 如果使用ThinkPHP的迁移工具
php think migrate:run

# 或者手动执行数据库迁移文件中的SQL语句
```

### 2. 路由配置

日志管理功能已经包含了完整的路由配置文件 `route/log.php`，确保该文件被正确加载。

### 3. 中间件配置（可选）

如果需要使用权限控制和自动清理功能，可以在 `app/middleware.php` 中添加LogMiddleware：

```php
return [
    // 其他中间件...
    \app\middleware\LogMiddleware::class,
];
```

## 使用方法

### 访问日志管理界面

通过以下URL访问日志管理界面：

```
http://your-domain/log/index
```

或者

```
http://your-domain/admin/logs
```

### 主要功能操作

#### 1. 查看日志列表

- 页面会自动加载日志文件列表
- 支持分页浏览
- 可以按文件大小、修改时间等排序
- 显示文件名、大小、创建时间、修改时间等信息

#### 2. 删除日志文件

**单个删除：**
- 点击日志文件行右侧的"预览"按钮查看内容
- 点击"删除"按钮删除单个文件

**批量删除：**
- 勾选需要删除的日志文件
- 点击批量删除按钮
- 确认删除操作

#### 3. 清理过期日志

- 点击"清理过期日志"按钮
- 系统会根据配置的保留天数自动清理过期文件
- 清理完成后显示删除的文件数量

#### 4. 配置设置

- 点击"配置设置"按钮
- 可以设置以下参数：
  - **保留天数**：日志文件保留天数（1-365天）
  - **自动清理**：是否启用自动清理过期日志
  - **最大文件大小**：预览文件的最大大小（MB）

#### 5. 预览日志内容

- 点击"预览"按钮查看日志文件内容
- 默认显示最后100行内容
- 支持滚动查看完整内容
- 内容按行显示，便于阅读

## 自动清理机制

### 工作原理

系统采用请求触发式自动清理机制，无需配置crontab：

1. **中间件触发**：每次访问日志管理相关页面时，有10%的概率触发自动清理检查
2. **时间检查**：检查距离上次清理是否超过24小时
3. **执行清理**：如果超过24小时且启用了自动清理，则执行清理操作
4. **记录日志**：记录清理操作的结果和统计信息

### 优势

- ✅ **无需服务器配置**：不需要配置crontab或其他定时任务
- ✅ **低资源消耗**：只在有访问时才检查，避免空转
- ✅ **智能触发**：随机概率触发，避免每次请求都检查
- ✅ **可配置性**：可以通过配置开关控制是否启用

## 配置参数说明

### log_retention_days
- **类型**：整数
- **范围**：1-365
- **默认值**：7
- **说明**：日志文件保留天数，超过此天数的日志文件将被自动清理

### log_auto_clean
- **类型**：布尔值（0/1）
- **默认值**：0
- **说明**：是否启用自动清理过期日志功能

### log_max_file_size
- **类型**：整数
- **范围**：1-100
- **默认值**：10
- **说明**：日志预览时允许的最大文件大小（MB），超过此大小的文件无法预览

## 权限控制

### 管理员权限检查

系统包含基础的权限检查机制：

1. **中间件检查**：LogMiddleware会检查访问日志管理页面的权限
2. **控制器检查**：LogController中的每个方法都会检查权限
3. **可扩展性**：可以根据实际需求扩展权限检查逻辑

### 自定义权限检查

可以根据项目需求修改权限检查逻辑：

```php
// 在LogController.php中
private function checkAdminPermission()
{
    // 示例：检查用户是否登录
    $user = session('user');
    if (!$user) {
        return false;
    }
    
    // 示例：检查用户角色
    if ($user['role'] !== 'admin') {
        return false;
    }
    
    return true;
}
```

## 文件结构

```
app/
├── api/
│   └── controller/
│       └── LogController.php          # 日志管理控制器
├── middleware/
│   └── LogMiddleware.php               # 日志管理中间件
└── service/
    └── LogService.php                 # 日志服务类

app/media/model/
└── SysConfigModel.php                 # 系统配置模型

route/
└── log.php                            # 日志管理路由

view/
└── log/
    └── index.html                     # 日志管理页面

public/assets/index/css/
└── log.css                            # 日志管理样式

database/migrations/
└── 20240101_create_log_config_table.php  # 数据库迁移文件
```

## 注意事项

### 1. 文件权限

确保Web服务器对以下目录有读写权限：
- `runtime/log/` - 日志文件存储目录
- `runtime/cache/` - 缓存文件存储目录

### 2. 安全考虑

- 日志管理功能应该只对管理员开放
- 建议在生产环境中启用HTTPS
- 定期检查日志文件，避免敏感信息泄露

### 3. 性能优化

- 对于大量日志文件，建议定期清理
- 可以根据需要调整分页大小
- 大文件预览可能会影响性能，建议合理设置最大文件大小

### 4. 备份建议

- 在清理日志前，建议先备份重要的日志文件
- 可以设置较长的保留天数以确保有足够的时间进行备份

## 故障排除

### 常见问题

**Q: 无法访问日志管理页面**
A: 检查路由配置是否正确加载，确保有访问权限

**Q: 自动清理不生效**
A: 检查是否启用了自动清理配置，确保缓存目录有写入权限

**Q: 无法预览日志文件**
A: 检查文件大小是否超过限制，确保文件存在且可读

**Q: 配置保存失败**
A: 检查数据库连接是否正常，确保config表存在且有写入权限

### 调试方法

1. **查看日志**：检查系统日志文件中的错误信息
2. **检查权限**：确认文件和目录权限设置正确
3. **测试连接**：验证数据库连接是否正常
4. **清除缓存**：尝试清除系统缓存后重试

## 更新日志

### v1.0.0 (2024-01-01)
- ✨ 初始版本发布
- 📋 实现日志文件列表查看功能
- 🗑️ 支持单个和批量删除日志文件
- ⚙️ 添加日志配置管理功能
- 🔄 实现自动清理过期日志机制
- 👁️ 支持日志文件内容预览
- 🎨 优化用户界面和交互体验

## 技术支持

如果在使用过程中遇到问题，请：

1. 查看本文档的故障排除部分
2. 检查系统日志获取详细错误信息
3. 确认环境配置符合要求
4. 联系技术支持团队

---

*本文档最后更新时间：2024-01-01*