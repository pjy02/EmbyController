<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日志管理</title>
    <link rel="stylesheet" href="/assets/index/css/layui.css">
    <link rel="stylesheet" href="/assets/index/css/style.css">
    <link rel="stylesheet" href="/assets/index/css/log.css">
    <style>
        .log-container {
            padding: 20px;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .log-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .log-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .log-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .log-table {
            margin-top: 20px;
        }
        .log-preview {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        .log-preview .log-line {
            margin-bottom: 5px;
            padding: 2px 5px;
            border-radius: 2px;
        }
        .log-preview .log-line:hover {
            background: #e8e8e8;
        }
        .config-form {
            max-width: 500px;
        }
        .config-form .layui-form-item {
            margin-bottom: 20px;
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-enabled {
            background: #5FB878;
            color: #fff;
        }
        .status-disabled {
            background: #FFB800;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="log-container">
        <div class="log-header">
            <div class="log-title">日志管理</div>
            <div class="log-actions">
                <button class="layui-btn layui-btn-sm" id="refreshBtn">
                    <i class="layui-icon layui-icon-refresh"></i> 刷新
                </button>
                <button class="layui-btn layui-btn-sm layui-btn-danger" id="cleanExpiredBtn">
                    <i class="layui-icon layui-icon-delete"></i> 清理过期日志
                </button>
                <button class="layui-btn layui-btn-sm layui-btn-normal" id="configBtn">
                    <i class="layui-icon layui-icon-set"></i> 配置设置
                </button>
            </div>
        </div>

        <div class="log-table">
            <table id="logTable" lay-filter="logTable"></table>
        </div>
    </div>

    <!-- 操作列模板 -->
    <script type="text/html" id="operationTpl">
        <a class="layui-btn layui-btn-xs" lay-event="preview">预览</a>
        <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">删除</a>
    </script>

    <!-- 文件大小模板 -->
    <script type="text/html" id="sizeTpl">
        <span>{{ d.size_formatted }}</span>
    </script>

    <!-- 状态模板 -->
    <script type="text/html" id="statusTpl">
        <span class="status-badge status-enabled">正常</span>
    </script>

    <!-- 配置设置弹窗 -->
    <script type="text/html" id="configTpl">
        <form class="layui-form config-form" lay-filter="configForm">
            <div class="layui-form-item">
                <label class="layui-form-label">保留天数</label>
                <div class="layui-input-block">
                    <input type="number" name="retention_days" required lay-verify="required|number" min="1" max="365" class="layui-input" value="7">
                    <div class="layui-form-mid layui-text-em">日志文件保留天数，超过将自动删除</div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">自动清理</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="auto_clean" lay-skin="switch" lay-text="开启|关闭" checked>
                    <div class="layui-form-mid layui-text-em">开启后将自动清理过期日志</div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">最大文件大小</label>
                <div class="layui-input-block">
                    <input type="number" name="max_file_size" required lay-verify="required|number" min="1" max="100" class="layui-input" value="10">
                    <div class="layui-form-mid layui-text-em">预览文件最大大小(MB)</div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="configSubmit">保存配置</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </script>

    <!-- 日志预览弹窗 -->
    <script type="text/html" id="previewTpl">
        <div class="log-preview" id="logPreview">
            <div style="text-align: center; color: #999; padding: 20px;">加载中...</div>
        </div>
    </script>

    <script src="/assets/index/js/jquery-3.7.1.min.js"></script>
    <script src="/assets/index/js/layui.js"></script>
    <script>
        layui.use(['table', 'form', 'layer', 'util'], function(){
            var table = layui.table;
            var form = layui.form;
            var layer = layui.layer;
            var util = layui.util;
            var $ = layui.$;

            // 初始化表格
            var tableIns = table.render({
                elem: '#logTable',
                url: '/api/log/list',
                method: 'get',
                page: true,
                limit: 20,
                limits: [10, 20, 50, 100],
                cols: [[
                    {type: 'checkbox', fixed: 'left'},
                    {field: 'file_name', title: '文件名', width: 200},
                    {field: 'size', title: '文件大小', width: 120, templet: '#sizeTpl'},
                    {field: 'mtime_formatted', title: '修改时间', width: 160},
                    {field: 'ctime_formatted', title: '创建时间', width: 160},
                    {field: 'status', title: '状态', width: 80, templet: '#statusTpl'},
                    {title: '操作', width: 150, toolbar: '#operationTpl', fixed: 'right'}
                ]],
                parseData: function(res){
                    return {
                        "code": res.code === 200 ? 0 : res.code,
                        "msg": res.message,
                        "count": res.data.total,
                        "data": res.data.items
                    };
                },
                request: {
                    pageName: 'page',
                    limitName: 'page_size'
                }
            });

            // 刷新按钮
            $('#refreshBtn').on('click', function(){
                tableIns.reload();
            });

            // 清理过期日志按钮
            $('#cleanExpiredBtn').on('click', function(){
                layer.confirm('确定要清理所有过期日志吗？', {icon: 3, title:'提示'}, function(index){
                    $.ajax({
                        url: '/api/log/clean-expired',
                        method: 'POST',
                        success: function(res){
                            if(res.code === 200){
                                layer.msg('成功清理 ' + res.data.deleted_count + ' 个过期日志文件', {icon: 1});
                                tableIns.reload();
                            } else {
                                layer.msg(res.message || '清理失败', {icon: 2});
                            }
                        },
                        error: function(){
                            layer.msg('网络错误', {icon: 2});
                        }
                    });
                    layer.close(index);
                });
            });

            // 配置设置按钮
            $('#configBtn').on('click', function(){
                // 先获取当前配置
                $.ajax({
                    url: '/api/log/config',
                    method: 'GET',
                    success: function(res){
                        if(res.code === 200){
                            var config = res.data;
                            // 渲染配置表单
                            layer.open({
                                type: 1,
                                title: '日志配置设置',
                                area: ['600px', '400px'],
                                content: layui.laytpl($('#configTpl').html()).render(),
                                success: function(layero, index){
                                    // 设置表单值
                                    form.val('configForm', {
                                        'retention_days': config.retention_days || 7,
                                        'auto_clean': config.auto_clean === 1,
                                        'max_file_size': config.max_file_size || 10
                                    });
                                    form.render();
                                }
                            });
                        } else {
                            layer.msg(res.message || '获取配置失败', {icon: 2});
                        }
                    },
                    error: function(){
                        layer.msg('网络错误', {icon: 2});
                    }
                });
            });

            // 监听工具条
            table.on('tool(logTable)', function(obj){
                var data = obj.data;
                if(obj.event === 'preview'){
                    // 预览日志
                    layer.open({
                        type: 1,
                        title: '预览日志: ' + data.file_name,
                        area: ['800px', '600px'],
                        content: layui.laytpl($('#previewTpl').html()).render(),
                        success: function(layero, index){
                            // 加载日志内容
                            $.ajax({
                                url: '/api/log/preview',
                                method: 'GET',
                                data: {file_name: data.file_name, lines: 100},
                                success: function(res){
                                    if(res.code === 200){
                                        var content = '';
                                        res.data.content.forEach(function(line){
                                            content += '<div class="log-line">' + line + '</div>';
                                        });
                                        $('#logPreview').html(content);
                                    } else {
                                        $('#logPreview').html('<div style="text-align: center; color: #ff5722; padding: 20px;">' + (res.message || '加载失败') + '</div>');
                                    }
                                },
                                error: function(){
                                    $('#logPreview').html('<div style="text-align: center; color: #ff5722; padding: 20px;">网络错误</div>');
                                }
                            });
                        }
                    });
                } else if(obj.event === 'delete'){
                    // 删除日志
                    layer.confirm('确定要删除日志文件 "' + data.file_name + '" 吗？', {icon: 3, title:'提示'}, function(index){
                        $.ajax({
                            url: '/api/log/delete',
                            method: 'POST',
                            data: {file_name: data.file_name},
                            success: function(res){
                                if(res.code === 200){
                                    layer.msg('删除成功', {icon: 1});
                                    obj.del();
                                } else {
                                    layer.msg(res.message || '删除失败', {icon: 2});
                                }
                            },
                            error: function(){
                                layer.msg('网络错误', {icon: 2});
                            }
                        });
                        layer.close(index);
                    });
                }
            });

            // 监听表单提交
            form.on('submit(configSubmit)', function(data){
                $.ajax({
                    url: '/api/log/config',
                    method: 'POST',
                    data: data.field,
                    success: function(res){
                        if(res.code === 200){
                            layer.msg('配置保存成功', {icon: 1});
                            layer.closeAll('page');
                        } else {
                            layer.msg(res.message || '保存失败', {icon: 2});
                        }
                    },
                    error: function(){
                        layer.msg('网络错误', {icon: 2});
                    }
                });
                return false; // 阻止表单跳转
            });

            // 批量删除
            var active = {
                batchDel: function(){
                    var checkStatus = table.checkStatus('logTable');
                    var checkData = checkStatus.data; // 得到选中的数据

                    if(checkData.length === 0){
                        layer.msg('请选择要删除的日志文件', {icon: 0});
                        return;
                    }

                    layer.confirm('确定要删除选中的 ' + checkData.length + ' 个日志文件吗？', {icon: 3, title:'提示'}, function(index){
                        var fileNames = checkData.map(function(item){ return item.file_name; });
                        
                        $.ajax({
                            url: '/api/log/batch-delete',
                            method: 'POST',
                            data: {file_names: fileNames},
                            success: function(res){
                                if(res.code === 200){
                                    layer.msg('成功删除 ' + res.data.deleted_count + ' 个文件', {icon: 1});
                                    tableIns.reload();
                                } else {
                                    layer.msg(res.message || '删除失败', {icon: 2});
                                }
                            },
                            error: function(){
                                layer.msg('网络错误', {icon: 2});
                            }
                        });
                        layer.close(index);
                    });
                }
            };

            $('.layui-btn-container .layui-btn').on('click', function(){
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
        });
    </script>
</body>
</html>